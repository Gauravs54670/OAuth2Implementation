<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="ChangePassword.css">
</head>
<body>
    <div class="main-container">
        <img src="images/bg2.jpeg" id="bg-image" alt="Background">
        <div class="main-container2">
            <h2>Change password</h2>
            <p>Change your password here!</p>
            <!-- Dashboard content goes here -->
        </div>
        <div class="main-container3">
            <div class="main-container4">
                <p>Update your password here</p>
                <form id="changePasswordForm">
                <div class="form-group">
                    <label for="phone">Current Password</label>
                    <input type="text" id="currentPassword" name="phone" placeholder="Enter your current password">
                    <small class="error" id="passwordError"></small>
                </div>
                <div class="form-group">
                    <label for="bio" id="bio">New password</label>
                    <input id="newPassword" name="newPassword" placeholder="Enter your new password">
                    <small class="error" id="newPasswordError"></small>
                </div>
                <button type="submit" id="btn">Submit</button>
                <button type="button" id="btn2">Forgot Password</button>
            </form>
            </div>
        </div>
    </div> 
</body>
<script>
    document.querySelector("#btn2").addEventListener("click", function() {
        window.location.href = "ForgotPassword.html";
    });
    document.querySelector("#changePasswordForm").addEventListener("submit", async function(event) {
        event.preventDefault();
        let currentPassword = document.querySelector("#currentPassword").value.trim();
        let newPassword = document.querySelector("#newPassword").value.trim();
        if(!currentPassword || !newPassword) {
            alert("Please fill all the fields");
            return;
        }
        try {
            const backendResponse = await fetch(
                "http://localhost:8080/api/user/change-password?newPassword=" + encodeURIComponent(newPassword) + "&oldPassword=" + encodeURIComponent(currentPassword),
                {
                    method : "PUT",
                    headers : {
                        "Authorization" : "Bearer " + localStorage.getItem("token"),
                        "Content-Type" : "application/json"
                    }
                }
            );
            if(backendResponse.ok){
                const data = await backendResponse.json();
                const response = data.response;
                alert("Password changed successfully");
                window.location.href = "Dashboard.html";
            }
            else if(backendResponse.status === 401){
                alert("Session expired. Please login again.");
                localStorage.removeItem("token");
                window.location.href = "SignIn.html";
            }
            else{
                const errorData = await backendResponse.json();
                
                alert(errorData.message || "Failed to change password");
            }
        } catch (error) {
            alert("An error occurred: " + error.message);
        }
    });
</script>
</html>